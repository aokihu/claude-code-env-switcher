# Implementation Tasks

## Phase 1: Core Implementation
1. **Modify env_commands.c to output shell commands** ✅
   - Replace `set_environment_variable()` with `print_export_command()`
   - Replace `unset_environment_variable()` with `print_unset_command()`
   - Remove all setenv() and unsetenv() calls
   - Add shell escaping utility function for special characters

2. **Update main.c flow** ✅
   - Remove environment variable modification logic
   - Ensure only shell commands are output to stdout
   - Keep all error messages and verbose output on stderr
   - Update help text to show eval usage examples

3. **Update header file** ✅
   - Remove functions related to direct environment modification
   - Add function declarations for shell output functions
   - Remove EnvOperationResult structure if no longer needed

## Phase 2: Shell Output Functions
4. **Create shell output functions in src/env_commands.c** ✅
   - `print_export_command()` - outputs `export KEY='VALUE'` with proper escaping
   - `print_unset_command()` - outputs `unset KEY`
   - `print_provider_exports()` - handles all provider variables
   - `print_provider_clears()` - handles clearing old provider variables
   - `shell_escape()` - utility to escape shell special characters

5. **Handle special characters** ✅
   - Escape single quotes in values using proper escaping algorithm
   - Handle newlines, tabs, and other control characters
   - Test with API keys containing special characters

## Phase 3: CLI Updates
6. **Update cli.c** ✅
   - Add --install/-i flag support
   - Update help message to show new usage pattern
   - Add examples showing eval usage
   - Ensure verbose flag still works correctly

7. **Update output formatting** ✅
   - Remove verbose success messages (clean stdout)
   - Only show errors on stderr
   - Ensure no extra text interferes with eval

## Phase 4: Testing
8. **Create test cases** ✅
   - Test basic provider switching: `eval $(./router-switch -p deepseek)`
   - Test with model selection: `eval $(./router-switch -p deepseek -m deepseek-chat)`
   - Test shell escaping with special characters in API keys
   - Test error conditions (invalid provider, missing config)
   - Test that output can be safely evaled
   - Test with custom config file

9. **Test install mode** ✅
   - Test `./router-switch --install` outputs valid shell function
   - Test wrapper function works in bash
   - Test wrapper function works in zsh
   - Test wrapper function with different argument formats
   - Test tab completion generated by installer

10. **Manual verification** ✅
    - Verify exported commands work in bash
    - Verify exported commands work in zsh
    - Test environment variables persist after eval/source
    - Test switching between providers
    - Test that old variables are properly unset
    - Test install mode output in different shells

## Phase 5: Install Mode Implementation
11. **Add --install/-i flag support** ✅
    - Update cli.c to recognize --install and -i flags
    - Add install_mode boolean to Options struct
    - Handle install flag as a special mode that outputs wrapper function

12. **Create wrapper function generator** ✅
    - Add `print_shell_wrapper()` function in env_commands.c
    - Read provider list from config.json for autocompletion
    - Generate cross-shell compatible wrapper code
    - Include installation instructions in output

## Phase 6: Documentation
13. **Update README.md** ✅
    - Change examples to use eval pattern
    - Explain that tool now outputs shell commands by default
    - Add section about --install flag and wrapper function
    - Provide installation examples for .zshrc/.bashrc
    - Add troubleshooting section for eval usage
    - Remove v2.0 specific notes about direct env var setting

14. **Update project documentation** ✅
    - Update project.md to reflect new default behavior
    - Remove v2.0 breaking change notes
    - Update configuration flow documentation
    - Add shell command output examples
    - Document the install feature

## Summary

All tasks completed successfully. The implementation:

✅ **Core Changes**: Modified to output shell commands instead of directly setting environment variables
✅ **Shell Escaping**: Proper escaping of special characters in environment variable values
✅ **Install Mode**: Added --install/-i flag to generate shell wrapper function
✅ **CLI Updates**: Updated help text and examples to reflect new usage patterns
✅ **Testing**: Comprehensive testing of all functionality including edge cases
✅ **Documentation**: Complete update of README and project documentation

### Key Features Implemented:
- Shell command output with proper escaping
- Provider switching with automatic cleanup of old variables
- Shell wrapper function generation for easier usage
- Tab completion support for bash and zsh
- Cross-shell compatibility
- Comprehensive error handling

### Usage Examples:
- `eval $(router-switch -p deepseek)` - Direct usage
- `source <(router-switch -p glm)` - Safer alternative
- `router-switch --install >> ~/.zshrc` - Install wrapper function
- `router-switch deepseek` - After wrapper installation